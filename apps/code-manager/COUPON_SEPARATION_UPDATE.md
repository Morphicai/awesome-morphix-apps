# 优惠券分离存储与有效期功能更新

## ✅ 完成的功能

### 1. **分离存储优惠券**
- ✅ 创建的优惠券和收到的优惠券分开保存
- ✅ 使用两个独立的 collection：
  - `created_coupons` - 我创建的优惠券
  - `received_coupons` - 我收到的优惠券

### 2. **UI 区分显示**
- ✅ 列表中分两个区域显示：
  - "我创建的" 区域（带数量徽章）
  - "我收到的" 区域（带数量徽章）
- ✅ 详情页显示优惠券来源标识

### 3. **权限控制**
- ✅ 收到的优惠券只能删除，不能验券
- ✅ 验券页面显示提示："收到的优惠券不支持验券操作"
- ✅ 创建的优惠券可以正常验券

### 4. **URL 参数识别与领取**
- ✅ 首次进入时自动检查 URL 中的 `code` 参数
- ✅ 如果 code 不在已有列表中，弹窗提示领取
- ✅ 确认后保存到"我收到的"列表
- ✅ 如果是自己创建的，提示"这是您创建的优惠券"
- ✅ 如果已领取过，提示"您已经领取过这张优惠券了"
- ✅ 领取成功后清除 URL 参数

### 5. **有效期功能**
- ✅ 创建优惠券时必填有效期字段
- ✅ 有效期验证：不能早于今天
- ✅ 优惠券图片中显示有效期
- ✅ 详情页显示有效期信息

### 6. **编码文字优化**
- ✅ 移除 30% 透明度
- ✅ 编码文字改为白色不透明，加粗显示
- ✅ 提高可读性

## 📁 修改的文件

### 核心服务
1. **src/services/StorageService.js**
   - 分离存储逻辑
   - `saveCreatedCoupon()` - 保存创建的优惠券
   - `saveReceivedCoupon()` - 保存收到的优惠券
   - `getCreatedCoupons()` - 获取创建的列表
   - `getReceivedCoupons()` - 获取收到的列表
   - `getAllCoupons()` - 返回 `{ created: [], received: [] }`

2. **src/services/CouponService.js**
   - 添加 `receiveCoupon()` 方法用于领取优惠券
   - 创建时保存到 created collection
   - 支持有效期字段

3. **src/services/ImageService.js**
   - 编码文字改为白色不透明
   - 添加有效期显示逻辑

### UI 组件
4. **src/components/CouponCreatorEnhanced.jsx**
   - 添加有效期输入字段（必填）
   - 有效期验证逻辑

5. **src/components/CouponList.jsx**
   - 分区显示"我创建的"和"我收到的"
   - 每个区域显示数量徽章

6. **src/components/CouponDetailModal.jsx**
   - 显示有效期信息
   - 显示优惠券来源标识

7. **src/components/ValidationResultModal.jsx**
   - 收到的优惠券禁用验券按钮
   - 显示提示信息

8. **src/app.jsx**
   - URL 参数检查逻辑
   - 领取优惠券确认弹窗
   - 领取成功后刷新列表

### 样式文件
9. **src/styles/CouponList.module.css**
   - 添加分区样式
   - 区域标题和徽章样式

10. **src/styles/ValidationResultModal.module.css**
    - 添加警告提示样式

### 常量
11. **src/utils/constants.js**
    - 添加存储 collection 常量

## 🎯 使用场景

### 创建优惠券
```javascript
// 用户填写表单，包括有效期
{
  type: 'amount',
  amount: 100,
  companyName: '测试公司',
  note: '满200减100',
  expiryDate: '2025-12-31'  // 必填
}
```

### 分享优惠券
```
https://your-app.com/?code=ABC123
```

### 领取优惠券
1. 用户点击分享链接
2. 应用检测到 URL 中的 code 参数
3. 弹窗确认："发现优惠券 ABC123，是否领取？"
4. 确认后保存到"我收到的"列表

### 验券限制
- ✅ 我创建的优惠券：可以验券
- ❌ 我收到的优惠券：只能查看和删除，不能验券

## 🔄 数据结构

### 优惠券对象
```javascript
{
  code: 'ABC123',
  type: 'amount',
  amount: 100,
  discount: null,
  companyName: '测试公司',
  note: '满200减100',
  expiryDate: '2025-12-31',  // 新增
  isUsed: false,
  createdAt: Date,
  usedAt: null,
  source: 'created',  // 'created' | 'received'
  receivedAt: Date    // 仅收到的优惠券有此字段
}
```

### 存储结构
```javascript
// getAllCoupons() 返回
{
  created: [
    { code: 'ABC123', source: 'created', ... },
    { code: 'DEF456', source: 'created', ... }
  ],
  received: [
    { code: 'GHI789', source: 'received', receivedAt: Date, ... }
  ]
}
```

## 🎨 UI 改进

### 列表页
```
┌─────────────────────────────┐
│ 我创建的 [2]                │
├─────────────────────────────┤
│ ¥100  ABC123  未使用        │
│ ¥50   DEF456  已使用        │
├─────────────────────────────┤
│ 我收到的 [1]                │
├─────────────────────────────┤
│ 8.5折 GHI789  未使用        │
└─────────────────────────────┘
```

### 详情页
```
┌─────────────────────────────┐
│ 优惠券详情                  │
├─────────────────────────────┤
│ ¥100                        │
│ 编码: ABC123                │
│ 有效期至: 2025-12-31        │
│ 来源: [我创建的]            │
├─────────────────────────────┤
│ [保存图片]  [删除优惠券]    │
└─────────────────────────────┘
```

### 验券页（收到的优惠券）
```
┌─────────────────────────────┐
│ 验券结果                    │
├─────────────────────────────┤
│ ✓ 优惠券有效                │
│ ¥100                        │
│ 编码: GHI789                │
├─────────────────────────────┤
│ ⚠️ 收到的优惠券不支持验券操作│
│ [关闭]                      │
└─────────────────────────────┘
```

## 🔄 数据迁移机制

### 自动迁移
为了兼容旧数据，系统会在首次调用 `getAllCoupons()` 时自动执行数据迁移：

1. **检查迁移标记**
   - 使用 localStorage 存储迁移状态
   - 键名：`coupon_data_migrated`

2. **迁移流程**
   ```
   旧 collection (coupons)
         ↓
   检查是否已迁移
         ↓
   读取所有旧数据
         ↓
   逐条迁移到 created_coupons
         ↓
   标记迁移完成
   ```

3. **迁移规则**
   - 旧数据默认视为"我创建的"优惠券
   - 迁移到 `created_coupons` collection
   - 如果新 collection 中已存在，跳过该条数据
   - 迁移完成后设置标记，避免重复迁移

4. **向后兼容**
   - `getCoupon()` 方法会依次查询：
     1. created_coupons（我创建的）
     2. received_coupons（我收到的）
     3. coupons（旧数据，兼容查询）
   - 保证旧数据仍然可以被查询和使用

### 手动迁移
如果需要强制重新迁移，可以调用：
```javascript
const storageService = new StorageService();
await storageService.forceMigration();
```

### 清理旧数据
迁移完成后，旧数据会保留在原 collection 中。如需清理：
1. 确认新数据正常工作
2. 取消注释 `_cleanupLegacyData()` 调用
3. 重新触发迁移

**⚠️ 注意：清理旧数据是不可逆操作，请谨慎使用！**

## 🚀 测试建议

1. **创建优惠券**
   - 测试有效期必填验证
   - 测试有效期不能早于今天
   - 验证图片中显示有效期

2. **分享与领取**
   - 复制优惠券链接（带 code 参数）
   - 在新窗口打开，测试领取流程
   - 验证重复领取提示

3. **权限控制**
   - 尝试验证收到的优惠券
   - 验证提示信息正确显示
   - 确认只能删除不能验券

4. **列表显示**
   - 验证分区显示正确
   - 验证数量徽章准确
   - 测试排序逻辑

5. **数据迁移**
   - 如果有旧数据，首次打开应用会自动迁移
   - 检查控制台日志确认迁移状态
   - 验证旧优惠券出现在"我创建的"列表中
   - 确认旧优惠券仍可正常使用和验券

## 📊 迁移日志示例

```
开始检查旧数据迁移...
发现 5 条旧数据，开始迁移...
数据迁移完成: 成功 5 条, 失败 0 条
```

所有功能已完成并通过诊断检查！🎉
